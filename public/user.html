<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</title>
  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå -->
  <link rel="stylesheet" href="/style.css">

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4f46e5">

  <!-- Favicon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö browser -->
  <link rel="icon" type="image/png" href="/icon-192.png">
  <style>
    /* Modal ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;border:1px solid var(--border-color);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.15);width:100%;max-width:420px;padding:1.25rem}
    .modal h4{margin:0 0 .75rem 0;color:var(--primary-color)}
    .modal .row{display:flex;justify-content:space-between;margin:.25rem 0;color:var(--text-primary)}
    .modal .row span:first-child{color:var(--text-secondary)}
    .modal .actions{margin-top:1rem;text-align:right}

    /* ===== ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà promoBox ‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏â‡∏•‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ ===== */
    #promoBox{
      display:none;
      margin-top:.75rem;
      position:relative;
      overflow:hidden;
      border-radius:12px;
      padding:12px 14px;
      background: linear-gradient(180deg, #0f172a 0%, #111827 100%); /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏û‡∏∑‡πâ‡∏ô‡πÄ‡∏Ç‡πâ‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
      border: 1px solid rgba(255,255,255,.08);
    }

    /* ‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏†‡∏≤‡∏¢‡πÉ‡∏ô promoBox */
    .anniv-banner{
      text-align:center;
      position:relative;
      z-index:1;
    }
    .anniv-banner .line{
      font-family: "Kanit", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 900;
      line-height: 1.05;
      margin: 2px 0;
      letter-spacing: .02em;
      background-size: 200% 200%;
      -webkit-background-clip: text;
              background-clip: text;
      color: transparent;
      text-shadow: 0 0 0 transparent;
      animation: shimmer 4s linear infinite, softGlow 3s ease-in-out infinite alternate;
      white-space: nowrap;
    }

    /* ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô: 19th AMGT (‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏ô‡∏∏‡πà‡∏°) */
    .anniv-banner .line-top{
      font-size: clamp(18px, 4.8vw, 26px);
      background-image: linear-gradient(120deg, #ffffff, #e5e7eb, #ffffff);
    }

    /* ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏´‡∏•‡∏±‡∏Å: Happy Anniversary (‡∏ó‡∏≠‡∏á‡∏ô‡∏∏‡πà‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢) */
    .anniv-banner .line-main{
      font-size: clamp(20px, 6vw, 30px);
      background-image: linear-gradient(120deg, #fde047, #facc15, #fef08a, #fde047);
    }

    /* ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö */
    .anniv-banner .ico{
      display:inline-block;
      font-size: 1.15em;
      margin: 0 .3em;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.45));
      animation: floatY 3.8s ease-in-out infinite;
      vertical-align: -2px;
    }
    .anniv-banner .ico.coupon{ animation-duration: 4.4s; }

    /* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏ï‡∏ï‡∏µ‡πâ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ö‡∏≤ (CSS-only, 6 ‡∏ä‡∏¥‡πâ‡∏ô) */
    #promoBox .confetti{
      position:absolute; inset:0; pointer-events:none; z-index:0;
    }
    #promoBox .confetti i{
      position:absolute;
      width:6px; height:10px; border-radius:2px;
      opacity:.85;
      animation: fall 1.8s linear infinite;
    }
    /* ‡∏™‡∏µ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏ï‡∏ï‡∏µ‡πâ */
    #promoBox .confetti i:nth-child(1){ background:#f59e0b; left:8%;  animation-delay:0s; }
    #promoBox .confetti i:nth-child(2){ background:#ef4444; left:22%; animation-delay:.2s;}
    #promoBox .confetti i:nth-child(3){ background:#3b82f6; left:38%; animation-delay:.4s;}
    #promoBox .confetti i:nth-child(4){ background:#10b981; left:56%; animation-delay:.1s;}
    #promoBox .confetti i:nth-child(5){ background:#a855f7; left:74%; animation-delay:.35s;}
    #promoBox .confetti i:nth-child(6){ background:#eab308; left:88%; animation-delay:.55s;}

    /* Keyframes */
    @keyframes shimmer{
      0%{ background-position:0% 50%; }
      100%{ background-position:200% 50%; }
    }
    @keyframes softGlow{
      0%{ filter: drop-shadow(0 0 0px rgba(250, 204, 21, .35)); }
      100%{ filter: drop-shadow(0 0 8px rgba(250, 204, 21, .6)); }
    }
    @keyframes floatY{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-5px); }
    }
    @keyframes fall{
      0%{ transform: translateY(-8px) rotate(0deg); opacity:.0; }
      10%{ opacity:.85; }
      100%{ transform: translateY(56px) rotate(220deg); opacity:0; }
    }

    /* ‡∏•‡∏î‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß */
    @media (prefers-reduced-motion: reduce){
      .anniv-banner .line,
      .anniv-banner .ico{ animation: none; }
      #promoBox .confetti i{ animation: none; display:none; }
    }
  </style>
</head>
<body>
  <div class="container admin-container">
    <h2 class="title">
      <span class="emoji" aria-hidden="true">üè¶</span>
      <span class="title-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
    </h2>
    <div class="card">
      <h3>üë§ ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <div id="greeting">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      <p id="balance">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ... ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</p>

      <h3>‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</h3>
      <button id="scanBtn">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <div id="qr-reader" style="width: 300px; display: none; margin-top: 1rem;"></div>

      <div id="payBox" style="display:none; margin-top:1rem;" class="card">
        <div id="merchantInfo" class="message"></div>
        <label for="payAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</label>
        <input type="number" id="payAmount" min="1" step="1" inputmode="numeric" pattern="\d*" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° ‚â• 1" />
        <button id="payBtn" class="btn-success">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</button>
      </div>

      <button id="logoutBtn" class="btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ -->
  <div id="paymentOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="paymentTitle">
    <div class="modal">
      <h4 id="paymentTitle">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>
      <div class="row"><span>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</span><strong id="mName">-</strong></div>
      <div class="row"><span>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span><strong id="mAmount">-</strong></div>
      <div class="row"><span>‡πÄ‡∏ß‡∏•‡∏≤</span><strong id="mTime">-</strong></div>
      <div class="row"><span>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span><strong id="mRemain">-</strong></div>

      <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå + ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏ï‡∏ï‡∏µ‡πâ‡πÄ‡∏ö‡∏≤) -->
      <div id="promoBox" class="message success" aria-live="polite"></div>

      <div class="actions">
        <button id="closeModal" class="btn-secondary">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- html5-qrcode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script>
    // ====== ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô/‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏û‡∏¥‡πÄ‡∏®‡∏© ======
    const PROMO_MESSAGE = '19th AMGT Happy Anniversary';
    const PROMO_ICON = 'üéÅ';

    // helper
    function withLoading(btn, action) {
      btn.classList.add('loading');
      btn.disabled = true;
      return Promise.resolve()
        .then(action)
        .finally(() => {
          btn.classList.remove('loading');
          btn.disabled = false;
        });
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    window.currentUser = null;
    fetch('/api/me')
      .then(res => { if (!res.ok) { window.location.href = '/login.html'; } return res.json(); })
      .then(user => {
        window.currentUser = user;
        const displayName = user.name || user.username;
        document.getElementById('greeting').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${displayName} `;
        document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${user.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
      })
      .catch(() => { window.location.href = '/login.html'; });

    // Helper: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å id (fallback ‡πÄ‡∏õ‡πá‡∏ô id ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
    async function lookupUserBasic(id){
      try{
        const res = await fetch(`/api/user-basic?id=${encodeURIComponent(id)}`);
        if(!res.ok) throw 0;
        const data = await res.json();
        return data.name || data.username || id;
      }catch{ return id; }
    }

    // Modal helpers
    const overlay = document.getElementById('paymentOverlay');
    const closeModalBtn = document.getElementById('closeModal');
    const promoBox = document.getElementById('promoBox');

    function renderAnniversaryBanner(noteText){
      // ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô promoBox (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°)
      return `
        <div class="anniv-banner" role="status" aria-live="polite">
          <div class="line line-top">19th AMGT</div>
          <div class="line line-main">
            <span class="ico gift" aria-hidden="true">üéÅ</span>
            Happy Anniversary
            <span class="ico coupon" aria-hidden="true">üéä</span>
          </div>
        </div>
        <div class="confetti" aria-hidden="true">
          <i></i><i></i><i></i><i></i><i></i><i></i>
        </div>
      `;
    }

    function openPaymentModal({merchantName, amount, timeText, remain, note}){
      document.getElementById('mName').textContent = merchantName;
      document.getElementById('mAmount').textContent = `${amount} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
      document.getElementById('mTime').textContent = timeText;
      document.getElementById('mRemain').textContent = `${remain} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;

      // ‡πÉ‡∏™‡πà‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏â‡∏•‡∏≠‡∏á (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏î‡∏¥‡∏°)
      if (note && String(note).trim()) {
        promoBox.innerHTML = renderAnniversaryBanner(note);
        promoBox.style.display = 'block';
      } else {
        promoBox.style.display = 'none';
        promoBox.innerHTML = '';
      }

      overlay.style.display = 'flex';
      closeModalBtn.focus();
    }
    function closePaymentModal(){ overlay.style.display = 'none'; }
    closeModalBtn.addEventListener('click', closePaymentModal);
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closePaymentModal(); });

    // ---- Utilities ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö base64url -> JSON (‡πÉ‡∏ä‡πâ‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå) ----
    function base64UrlToJson(b64url) {
      const b64 = b64url.replace(/-/g, '+').replace(/_/g, '/')
        + '==='.slice((b64url.length + 3) % 4); // padding ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
      const text = atob(b64);
      return JSON.parse(text);
    }

    // ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    let qrScanner = null;
    let lastPayload = null;
    let lastMerchantId = null;
    let lastMerchantName = null;

    const scanBtn = document.getElementById('scanBtn');
    scanBtn.addEventListener('click', async () => {
      await withLoading(scanBtn, async () => {
        if (!qrScanner) qrScanner = new Html5Qrcode('qr-reader');
        const qrReader = document.getElementById('qr-reader');
        const payBox = document.getElementById('payBox');
        const infoBox = document.getElementById('merchantInfo');

        payBox.style.display = 'none';
        infoBox.textContent = '';
        qrReader.style.display = 'block';

        const onScanSuccess = async (decodedText) => {
          try { await qrScanner.stop(); } catch (e) {}
          qrReader.style.display = 'none';

          // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: (‡πÉ‡∏´‡∏°‡πà){raw,sig} ‡πÅ‡∏•‡∏∞ (‡πÄ‡∏î‡∏¥‡∏°){type,to}
          let parsed;
          try { parsed = JSON.parse(decodedText); }
          catch { alert('QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }

          let merchantId;
          if (parsed && parsed.raw && parsed.sig) {
            try {
              const data = base64UrlToJson(parsed.raw);
              if (data?.type !== 'merchant-receive' || !data?.to) {
                alert('QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return;
              }
              merchantId = data.to;
              lastPayload = JSON.stringify({ raw: parsed.raw, sig: parsed.sig });
            } catch {
              alert('QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return;
            }
          } else if (parsed?.type === 'merchant-receive' && parsed?.to) {
            merchantId = parsed.to;
            lastPayload = decodedText;
          } else {
            alert('QR ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï');
            return;
          }

          lastMerchantId = merchantId;
          lastMerchantName = await lookupUserBasic(merchantId);

          infoBox.className = 'message success';
          infoBox.textContent = `‡∏à‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô: ${lastMerchantName}`;
          document.getElementById('payBox').style.display = 'block';
        };

        const onScanFailure = () => { /* ‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á */ };

        await qrScanner.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        ).catch(err => {
          alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err);
        });
      });
    });

    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
    const payBtn = document.getElementById('payBtn');
    payBtn.addEventListener('click', async () => {
      await withLoading(payBtn, async () => {
        const raw = document.getElementById('payAmount').value;
        const amount = Math.trunc(Number(raw));
        if (!Number.isFinite(amount) || amount <= 0) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° > 0)');
          return;
        }
        if (window.currentUser && amount > window.currentUser.credit) {
          alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏û‡∏≠');
          return;
        }
        if (!lastPayload) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }
        try {
          const res = await fetch('/api/pay-qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payload: lastPayload, amount })
          });
          const data = await (res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text());
          if (!res.ok) throw new Error(typeof data === 'string' ? data : (data.message || '‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
          const me = await fetch('/api/me').then(r => r.json());
          window.currentUser = me;
          document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${me.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;

          // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏© (note)
          const timeText = new Date().toLocaleString('th-TH');
          openPaymentModal({
            merchantName: lastMerchantName || lastMerchantId,
            amount,
            timeText,
            remain: me.credit,
            note: PROMO_MESSAGE
          });

          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢
          document.getElementById('payAmount').value = '';
          document.getElementById('payBox').style.display = 'none';
        } catch (err) {
          alert(err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
        }
      });
    });

    // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', () => {
      withLoading(logoutBtn, async () => {
        await fetch('/logout');
        window.location.href = '/login.html';
      });
    });
  </script>
</body>
</html>