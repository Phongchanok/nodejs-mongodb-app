<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="container admin-container">
  <h2>üè¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h2>
   <div class="card">
      <h3>üë§ ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
    <div id="greeting">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ!</div>
    <p id="balance">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ...</p>

    <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h3>
    <label for="amount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô</label>
    <input type="number" id="amount" min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">
    <button id="generateBtn">‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
    <div id="qrContainer" style="margin-top:1rem;"></div>

    <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>

  </div>

  <script>
    // Fetch the logged-in user info and update the page
    let currentUser = null;
    fetch('/api/me')
      .then(response => {
        if (!response.ok) {
          // If the user is not authenticated, redirect to login
          window.location.href = '/login.html';
        }
        return response.json();
      })
      .then(user => {
        currentUser = user;
        // Show the user's full name if available, otherwise fall back
        // to the username. Employee accounts imported from CSV will
        // have a name field that we prefer to display.
        const displayName = user.name || user.username;
        document.getElementById('greeting').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${displayName}!`;
        document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${user.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
      })
      .catch(err => {
        console.error(err);
      });

    // Generate QR Code when user clicks the button
    document.getElementById('generateBtn').addEventListener('click', () => {
      const amount = document.getElementById('amount').value;
      if (!amount || parseFloat(amount) <= 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        return;
      }
      // Prevent generating QR if amount exceeds current credit
      const num = parseFloat(amount);
      if (currentUser && num > currentUser.credit) {
        alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
        return;
      }
      fetch('/api/generate-qr', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ amount })
      })
        .then(res => {
          if (!res.ok) {
            return res.text().then(text => { throw new Error(text); });
          }
          return res.json();
        })
        .then(data => {
          const container = document.getElementById('qrContainer');
          container.innerHTML = '';
          const img = document.createElement('img');
          img.src = data.qrDataUri;
          img.alt = 'QR Code';
          img.style.maxWidth = '200px';
          container.appendChild(img);
        })
        .catch(err => alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`));
    });

    // Attach logout event
    document.getElementById('logoutBtn').addEventListener('click', () => {
      fetch('/logout')
        .then(() => {
          window.location.href = '/login.html';
        });
    });
  </script>
</body>
</html>