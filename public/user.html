<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Modal ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;border:1px solid var(--border-color);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.15);width:100%;max-width:420px;padding:1.25rem}
    .modal h4{margin:0 0 .75rem 0;color:var(--primary-color)}
    .modal .row{display:flex;justify-content:space-between;margin:.25rem 0;color:var(--text-primary)}
    .modal .row span:first-child{color:var(--text-secondary)}
    .modal .actions{margin-top:1rem;text-align:right}
    #promoBox { display:flex; gap:.5rem; align-items:center; }
    #promoBox .promo-icon { font-size:1.25rem; line-height:1; }
  </style>
</head>
<body>
  <div class="container admin-container">
    <h2>üè¶ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h2>
    <div class="card">
      <h3>üë§ ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <div id="greeting">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
      <p id="balance">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ... ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</p>

      <h3>‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</h3>
      <button id="scanBtn">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      <div id="qr-reader" style="width: 300px; display: none; margin-top: 1rem;"></div>

      <div id="payBox" style="display:none; margin-top:1rem;" class="card">
        <div id="merchantInfo" class="message"></div>
        <label for="payAmount">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</label>
        <input type="number" id="payAmount" min="1" step="1" inputmode="numeric" pattern="\d*" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° ‚â• 1" />
        <button id="payBtn" class="btn-success">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</button>
      </div>

      <button id="logoutBtn" class="btn-danger">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>

  <!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ -->
  <div id="paymentOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="paymentTitle">
    <div class="modal">
      <h4 id="paymentTitle">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h4>
      <div class="row"><span>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</span><strong id="mName">-</strong></div>
      <div class="row"><span>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞</span><strong id="mAmount">-</strong></div>
      <div class="row"><span>‡πÄ‡∏ß‡∏•‡∏≤</span><strong id="mTime">-</strong></div>
      <div class="row"><span>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</span><strong id="mRemain">-</strong></div>
      <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞ -->
      <div id="promoBox" class="message success" style="display:none; margin-top:.75rem;" aria-live="polite"></div>
      <div class="actions">
        <button id="closeModal" class="btn-secondary">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <!-- html5-qrcode ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script>
    // ====== ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô/‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏û‡∏¥‡πÄ‡∏®‡∏© ======
    const PROMO_MESSAGE = '‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö 19 ‡∏õ‡∏µ';
    const PROMO_ICON = 'üéÅ';

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    window.currentUser = null;
    fetch('/api/me')
      .then(res => { if (!res.ok) { window.location.href = '/login.html'; } return res.json(); })
      .then(user => {
        window.currentUser = user;
        const displayName = user.name || user.username;
        document.getElementById('greeting').textContent = `‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${displayName} `;
        document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${user.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
      })
      .catch(() => { window.location.href = '/login.html'; });

    // Helper: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å id (fallback ‡πÄ‡∏õ‡πá‡∏ô id ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
    async function lookupUserBasic(id){
      try{
        const res = await fetch(`/api/user-basic?id=${encodeURIComponent(id)}`);
        if(!res.ok) throw 0;
        const data = await res.json();
        return data.name || data.username || id;
      }catch{ return id; }
    }

    // Modal helpers
    const overlay = document.getElementById('paymentOverlay');
    const closeModalBtn = document.getElementById('closeModal');
    const promoBox = document.getElementById('promoBox'); // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå note ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô+‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    function openPaymentModal({merchantName, amount, timeText, remain, note}){
      document.getElementById('mName').textContent = merchantName;
      document.getElementById('mAmount').textContent = `${amount} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
      document.getElementById('mTime').textContent = timeText;
      document.getElementById('mRemain').textContent = `${remain} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;

      if (note && String(note).trim()) {
        promoBox.innerHTML = `
          <span class="promo-icon" aria-hidden="true">${PROMO_ICON}</span>
          <span class="promo-text">${note}</span>
        `;
        promoBox.style.display = 'flex';   // ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö CSS ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
      } else {
        promoBox.style.display = 'none';
      }

      overlay.style.display = 'flex';
      closeModalBtn.focus();
    }
    function closePaymentModal(){ overlay.style.display = 'none'; }
    closeModalBtn.addEventListener('click', closePaymentModal);
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closePaymentModal(); });

    // ---- Utilities ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö base64url -> JSON (‡πÉ‡∏ä‡πâ‡∏ö‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå) ----
    function base64UrlToJson(b64url) {
      const b64 = b64url.replace(/-/g, '+').replace(/_/g, '/')
        + '==='.slice((b64url.length + 3) % 4); // padding ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö
      const text = atob(b64);
      return JSON.parse(text);
    }

    // ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    let qrScanner = null;
    let lastPayload = null;
    let lastMerchantId = null;
    let lastMerchantName = null;

    document.getElementById('scanBtn').addEventListener('click', async () => {
      if (!qrScanner) qrScanner = new Html5Qrcode('qr-reader');
      const qrReader = document.getElementById('qr-reader');
      const payBox = document.getElementById('payBox');
      const infoBox = document.getElementById('merchantInfo');

      payBox.style.display = 'none';
      infoBox.textContent = '';
      qrReader.style.display = 'block';

      const onScanSuccess = async (decodedText) => {
        try { await qrScanner.stop(); } catch (e) {}
        qrReader.style.display = 'none';

        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: (‡πÉ‡∏´‡∏°‡πà){raw,sig} ‡πÅ‡∏•‡∏∞ (‡πÄ‡∏î‡∏¥‡∏°){type,to}
        let parsed;
        try { parsed = JSON.parse(decodedText); }
        catch { alert('QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }

        let merchantId;
        if (parsed && parsed.raw && parsed.sig) {
          try {
            const data = base64UrlToJson(parsed.raw);
            if (data?.type !== 'merchant-receive' || !data?.to) {
              alert('QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return;
            }
            merchantId = data.to;
            lastPayload = JSON.stringify({ raw: parsed.raw, sig: parsed.sig });
          } catch {
            alert('QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return;
          }
        } else if (parsed?.type === 'merchant-receive' && parsed?.to) {
          merchantId = parsed.to;
          lastPayload = decodedText;
        } else {
          alert('QR ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï');
          return;
        }

        lastMerchantId = merchantId;
        lastMerchantName = await lookupUserBasic(merchantId);

        infoBox.className = 'message success';
        infoBox.textContent = `‡∏à‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÉ‡∏´‡πâ‡∏£‡πâ‡∏≤‡∏ô: ${lastMerchantName}`;
        document.getElementById('payBox').style.display = 'block';
      };

      const onScanFailure = () => { /* ‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á */ };

      try {
        await qrScanner.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        );
      } catch (err) {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err);
      }
    });

    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞
    document.getElementById('payBtn').addEventListener('click', async () => {
      const raw = document.getElementById('payAmount').value;
      const amount = Math.trunc(Number(raw));
      if (!Number.isFinite(amount) || amount <= 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° > 0)');
        return;
      }
      if (window.currentUser && amount > window.currentUser.credit) {
        alert('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏û‡∏≠');
        return;
      }
      if (!lastPayload) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }
      try {
        const res = await fetch('/api/pay-qr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ payload: lastPayload, amount })
        });
        const data = await (res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text());
        if (!res.ok) throw new Error(typeof data === 'string' ? data : (data.message || '‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
        const me = await fetch('/api/me').then(r => r.json());
        window.currentUser = me;
        document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${me.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;

        // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏© (note)
        const timeText = new Date().toLocaleString('th-TH');
        openPaymentModal({
          merchantName: lastMerchantName || lastMerchantId,
          amount,
          timeText,
          remain: me.credit,
          note: PROMO_MESSAGE     // << ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        });

        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢
        document.getElementById('payAmount').value = '';
        document.getElementById('payBox').style.display = 'none';
      } catch (err) {
        alert(err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
      }
    });

    // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    document.getElementById('logoutBtn').addEventListener('click', () => {
      fetch('/logout').then(() => { window.location.href = '/login.html'; });
    });
  </script>
</body>
</html>
