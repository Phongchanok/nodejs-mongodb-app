<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>р╕Бр╕гр╕░р╣Ар╕Ыр╣Лр╕▓р╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓ | р╕Бр╕гр╕░р╣Ар╕Ыр╣Лр╕▓р╣Ар╕Др╕гр╕Фр╕┤р╕Х</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
    <h2>ЁЯПж р╕гр╕░р╕Ър╕Ър╕Бр╕гр╕░р╣Ар╕Ыр╣Лр╕▓р╣Ар╕Др╕гр╕Фр╕┤р╕Х</h2>
      <div class="card">
        <h3>ЁЯСд р╕лр╕Щр╣Йр╕▓р╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓</h3>
        <div id="greeting">р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Ф...</div>
        <div id="balance">р╕вр╕нр╕Фр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н: ... р╣Ар╕Др╕гр╕Фр╕┤р╕Х</div>
        <h3>QR р╕кр╕│р╕лр╕гр╕▒р╕Ър╕гр╕▒р╕Ър╣Ар╕Др╕гр╕Фр╕┤р╕Х</h3>
        <button id="genQrBtn">р╕кр╕гр╣Йр╕▓р╕З/р╕гр╕╡р╣Ар╕Яр╕гр╕К QR р╕гр╣Йр╕▓р╕Щ</button>
        <div id="qrContainer" style="margin-top:1rem;"></div>

      <button id="logoutBtn">р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ</button>
    </div>

    <!--
      The merchant can scan a QR code directly with their device's camera.
      Clicking the scan button will open the camera preview and start
      scanning for a QR code. When a code is detected the
      corresponding payload is automatically sent to the server to
      redeem the credit. This removes the need to paste the JSON
      payload manually.
    
    <button id="scanBtn">ЁЯУ╖ р╣Ар╕Ыр╕┤р╕Фр╕Бр╕ер╣Йр╕нр╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╕кр╣Бр╕Бр╕Щ QR</button>

    <div id="qr-reader" style="width: 300px; display: none; margin-top: 1rem;"></div>
    <div id="scanResult" style="margin-top: 1rem; color: green;">ЁЯУ╣ р╕Бр╕ер╣Йр╕нр╕Зр╕Ир╕░р╣Ар╕Ыр╕┤р╕Фр╕Чр╕╡р╣Ир╕Щр╕╡р╣И</div>
    <div id="scanResult" class="hidden">тЬЕ р╕гр╕▒р╕Ър╣Ар╕Др╕гр╕Фр╕┤р╕Х 100 р╣Ар╕Др╕гр╕Фр╕┤р╕Х р╕кр╕│р╣Ар╕гр╣Зр╕И!</div>

    <button id="logoutBtn">р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ</button>
  </div>
    -->

  <!-- Load html5-qrcode library from CDN to enable inтАСbrowser QR scanning. 
       This script defines the Html5Qrcode class used below. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<script>
  // р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е merchant р╕Др╕гр╕▒р╣Йр╕Зр╣Бр╕гр╕Б
  fetch('/api/me')
    .then(r => {
      if (!r.ok) location.href = '/login.html';
      return r.json();
    })
    .then(user => {
      if (user.role !== 'merchant') {
        location.href = `/${user.role}.html`;
        return;
      }
      document.getElementById('greeting').textContent = `р╕гр╣Йр╕▓р╕Щр╕Др╣Йр╕▓: ${user.username} `;
      document.getElementById('balance').textContent  = `р╕вр╕нр╕Фр╣Ар╕Др╕гр╕Фр╕┤р╕Х: ${user.credit} р╣Ар╕Др╕гр╕Фр╕┤р╕Х`;
    });

  // р╣Ар╕Юр╕┤р╣Ир╕бр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕гр╕╡р╣Ар╕Яр╕гр╕Кр╕вр╕нр╕Ф
  async function refreshBalance() {
    try {
      const me = await fetch('/api/me').then(r => r.json());
      if (me.role === 'merchant') {
        document.getElementById('balance').textContent = `р╕вр╕нр╕Фр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н: ${me.credit} р╣Ар╕Др╕гр╕Фр╕┤р╕Х`;
      }
    } catch {}
  }

  // Auto refresh р╕Чр╕╕р╕Б 5 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡ + р╣Ар╕бр╕╖р╣Ир╕нр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ър╕Цр╕╣р╕Бр╣Вр╕Яр╕Бр╕▒р╕кр╕Бр╕ер╕▒р╕Ър╕бр╕▓
  const intervalId = setInterval(refreshBalance, 5000);
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) refreshBalance();
  });

  // р╕Ыр╕╕р╣Ир╕бр╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ
  document.getElementById('logoutBtn').addEventListener('click', () => {
    fetch('/logout').then(() => location.href = '/login.html');
  });

  // р╕Ыр╕╕р╣Ир╕бр╕кр╕гр╣Йр╕▓р╕З QR (р╣Ар╕Фр╕┤р╕б)
  document.getElementById('genQrBtn').addEventListener('click', async () => {
    try {
      const res = await fetch('/api/merchant-qr', { credentials: 'same-origin' });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const img = document.createElement('img');
      img.src = data.dataUrl;
      img.alt = 'Merchant QR';
      img.style.maxWidth = '220px';
      const box = document.getElementById('qrContainer');
      box.innerHTML = '';
      box.appendChild(img);
    } catch (err) {
      alert('р╕кр╕гр╣Йр╕▓р╕З QR р╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И: ' + (err.message || 'р╣Др╕бр╣Ир╕Чр╕гр╕▓р╕Ър╕кр╕▓р╣Ар╕лр╕Хр╕╕'));
    }
  });


    
    /**
    // QR code scanning functionality
    let qrScanner;
    let scanning = false;
    document.getElementById('scanBtn').addEventListener('click', () => {
      // Prevent starting a new scan if one is already in progress or transitioning
      if (scanning) {
        return;
      }
      const qrReader = document.getElementById('qr-reader');
      const scanResult = document.getElementById('scanResult');

      // Initialise the scanner lazily
      if (!qrScanner) {
        qrScanner = new Html5Qrcode('qr-reader');
      }
      // Show the scanning area
      qrReader.style.display = 'block';
      scanResult.textContent = '';
      scanning = true;

      const onScanSuccess = (decodedText, decodedResult) => {
        // Stop scanning to release the camera
        qrScanner.stop().then(() => {
          qrReader.style.display = 'none';
          scanning = false;
        }).catch(() => {
          // Even if stopping fails, reset scanning flag
          scanning = false;
        });
        // Automatically redeem the scanned QR payload
        fetch('/api/redeem-qr', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ payload: decodedText })
        })
          .then(res => {
            if (!res.ok) {
              return res.text().then(text => { throw new Error(text); });
            }
            return res.json();
          })
          .then(data => {
            // Display success message
            scanResult.style.color = 'green';
            scanResult.textContent = data.message || 'р╕гр╕▒р╕Ър╣Ар╕Др╕гр╕Фр╕┤р╕Хр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в';
            // Refresh balance
            fetch('/api/me')
              .then(r => r.json())
              .then(user => {
                document.getElementById('balance').textContent = `р╕вр╕нр╕Фр╕Др╕Зр╣Ар╕лр╕ер╕╖р╕н: ${user.credit} р╣Ар╕Др╕гр╕Фр╕┤р╕Х`;
              });
          })
          .catch(err => {
            scanResult.style.color = 'red';
            scanResult.textContent = err.message || 'р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф';
          });
      };
      const onScanFailure = (error) => {
        // We intentionally ignore scan failures as the scanner continues
        // to scan until a code is found. See library docs for details.
      };
      qrScanner.start(
        // Use a simple string for facingMode as recommended by html5-qrcode
        // documentationуАР635396253272075тАаL474-L485уАС. Passing "environment" selects
        // the rear camera on most devices.
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        scanning = false;
        alert('р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Ыр╕┤р╕Фр╕Бр╕ер╣Йр╕нр╕Зр╣Др╕Фр╣Й: ' + err);
      });
    });
    */
  </script>
</body>
</html>