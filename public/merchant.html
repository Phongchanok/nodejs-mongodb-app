<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
      <div id="greeting">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ABC!</div>
      <div id="balance">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ... ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</div>
      <h3>QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h3>
      <button id="genQrBtn">‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä QR ‡∏£‡πâ‡∏≤‡∏ô</button>
      <div id="qrContainer" style="margin-top:1rem;"></div>

      <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!--
      The merchant can scan a QR code directly with their device's camera.
      Clicking the scan button will open the camera preview and start
      scanning for a QR code. When a code is detected the
      corresponding payload is automatically sent to the server to
      redeem the credit. This removes the need to paste the JSON
      payload manually.
    
    <button id="scanBtn">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô QR</button>

    <div id="qr-reader" style="width: 300px; display: none; margin-top: 1rem;"></div>
    <div id="scanResult" style="margin-top: 1rem; color: green;">üìπ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
    <div id="scanResult" class="hidden">‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï 100 ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

    <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
    -->

  <!-- Load html5-qrcode library from CDN to enable in‚Äëbrowser QR scanning. 
       This script defines the Html5Qrcode class used below. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script>
    // Load merchant info and ensure the logged in user has the correct role
    fetch('/api/me')
      .then(response => {
        if (!response.ok) {
          window.location.href = '/login.html';
        }
        return response.json();
      })
      .then(user => {
        // Redirect to proper dashboard if user is not merchant
        if (user.role !== 'merchant') {
          window.location.href = `/${user.role}.html`;
          return;
        }
        document.getElementById('greeting').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${user.username}! (‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤)`;
        document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${user.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
      })
      .catch(err => console.error(err));

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      fetch('/logout')
        .then(() => {
          window.location.href = '/login.html';
        });
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á QR:

document.getElementById('genQrBtn').addEventListener('click', async () => {
  try {
    const res = await fetch('/api/merchant-qr', {
      method: 'GET',
      credentials: 'same-origin'
    });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();

    const img = document.createElement('img');
    img.src = data.dataUrl;          // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å qrDataUri ‡πÄ‡∏õ‡πá‡∏ô dataUrl
    img.alt = 'Merchant QR';
    img.style.maxWidth = '220px';

    const box = document.getElementById('qrContainer');
    box.innerHTML = '';
    box.appendChild(img);
  } catch (err) {
    alert('‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
  }
});


    
    /**
    // QR code scanning functionality
    let qrScanner;
    let scanning = false;
    document.getElementById('scanBtn').addEventListener('click', () => {
      // Prevent starting a new scan if one is already in progress or transitioning
      if (scanning) {
        return;
      }
      const qrReader = document.getElementById('qr-reader');
      const scanResult = document.getElementById('scanResult');

      // Initialise the scanner lazily
      if (!qrScanner) {
        qrScanner = new Html5Qrcode('qr-reader');
      }
      // Show the scanning area
      qrReader.style.display = 'block';
      scanResult.textContent = '';
      scanning = true;

      const onScanSuccess = (decodedText, decodedResult) => {
        // Stop scanning to release the camera
        qrScanner.stop().then(() => {
          qrReader.style.display = 'none';
          scanning = false;
        }).catch(() => {
          // Even if stopping fails, reset scanning flag
          scanning = false;
        });
        // Automatically redeem the scanned QR payload
        fetch('/api/redeem-qr', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ payload: decodedText })
        })
          .then(res => {
            if (!res.ok) {
              return res.text().then(text => { throw new Error(text); });
            }
            return res.json();
          })
          .then(data => {
            // Display success message
            scanResult.style.color = 'green';
            scanResult.textContent = data.message || '‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
            // Refresh balance
            fetch('/api/me')
              .then(r => r.json())
              .then(user => {
                document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${user.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
              });
          })
          .catch(err => {
            scanResult.style.color = 'red';
            scanResult.textContent = err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
          });
      };
      const onScanFailure = (error) => {
        // We intentionally ignore scan failures as the scanner continues
        // to scan until a code is found. See library docs for details.
      };
      qrScanner.start(
        // Use a simple string for facingMode as recommended by html5-qrcode
        // documentation„Äê635396253272075‚Ä†L474-L485„Äë. Passing "environment" selects
        // the rear camera on most devices.
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        scanning = false;
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err);
      });
    });
    */
  </script>
</body>
</html>