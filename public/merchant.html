<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</title>
   <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå -->
  <link rel="stylesheet" href="/style.css">

  <!-- PWA manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4f46e5">

  <!-- Favicon ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö browser -->
  <link rel="icon" type="image/png" href="/icon-192.png">

</head>
<body>
    <div class="container">
    <h2 class="title">
      <span class="emoji" aria-hidden="true">üè¶</span>
      <span class="title-text">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</span>
    </h2>
      <div class="card">
        <h3>üë§ ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
        <div id="greeting">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        <div id="balance">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ... ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</div>
        <h3>QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</h3>
        <button id="genQrBtn">‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä QR ‡∏£‡πâ‡∏≤‡∏ô</button>
        <div id="qrContainer" style="margin-top:1rem;"></div>

      <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!--
      The merchant can scan a QR code directly with their device's camera.
      Clicking the scan button will open the camera preview and start
      scanning for a QR code. When a code is detected the
      corresponding payload is automatically sent to the server to
      redeem the credit. This removes the need to paste the JSON
      payload manually.
    
    <button id="scanBtn">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô QR</button>

    <div id="qr-reader" style="width: 300px; display: none; margin-top: 1rem;"></div>
    <div id="scanResult" style="margin-top: 1rem; color: green;">üìπ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
    <div id="scanResult" class="hidden">‚úÖ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï 100 ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>

    <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
    -->

  <!-- Load html5-qrcode library from CDN to enable in‚Äëbrowser QR scanning. 
       This script defines the Html5Qrcode class used below. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<script>
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• merchant ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  fetch('/api/me')
    .then(r => {
      if (!r.ok) location.href = '/login.html';
      return r.json();
    })
    .then(user => {
      if (user.role !== 'merchant') {
        location.href = `/${user.role}.html`;
        return;
      }
      document.getElementById('greeting').textContent = `‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: ${user.username} `;
      document.getElementById('balance').textContent  = `‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï: ${user.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
    });

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏¢‡∏≠‡∏î
  async function refreshBalance() {
    try {
      const me = await fetch('/api/me').then(r => r.json());
      if (me.role === 'merchant') {
        document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${me.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
      }
    } catch {}
  }

  // Auto refresh ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ + ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏ñ‡∏π‡∏Å‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
  const intervalId = setInterval(refreshBalance, 5000);
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) refreshBalance();
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
  document.getElementById('logoutBtn').addEventListener('click', () => {
    fetch('/logout').then(() => location.href = '/login.html');
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á QR (‡πÄ‡∏î‡∏¥‡∏°)
  document.getElementById('genQrBtn').addEventListener('click', async () => {
    try {
      const res = await fetch('/api/merchant-qr', { credentials: 'same-origin' });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      const img = document.createElement('img');
      img.src = data.dataUrl;
      img.alt = 'Merchant QR';
      img.style.maxWidth = '220px';
      const box = document.getElementById('qrContainer');
      box.innerHTML = '';
      box.appendChild(img);
    } catch (err) {
      alert('‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (err.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
    }
  });


    
    /**
    // QR code scanning functionality
    let qrScanner;
    let scanning = false;
    document.getElementById('scanBtn').addEventListener('click', () => {
      // Prevent starting a new scan if one is already in progress or transitioning
      if (scanning) {
        return;
      }
      const qrReader = document.getElementById('qr-reader');
      const scanResult = document.getElementById('scanResult');

      // Initialise the scanner lazily
      if (!qrScanner) {
        qrScanner = new Html5Qrcode('qr-reader');
      }
      // Show the scanning area
      qrReader.style.display = 'block';
      scanResult.textContent = '';
      scanning = true;

      const onScanSuccess = (decodedText, decodedResult) => {
        // Stop scanning to release the camera
        qrScanner.stop().then(() => {
          qrReader.style.display = 'none';
          scanning = false;
        }).catch(() => {
          // Even if stopping fails, reset scanning flag
          scanning = false;
        });
        // Automatically redeem the scanned QR payload
        fetch('/api/redeem-qr', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ payload: decodedText })
        })
          .then(res => {
            if (!res.ok) {
              return res.text().then(text => { throw new Error(text); });
            }
            return res.json();
          })
          .then(data => {
            // Display success message
            scanResult.style.color = 'green';
            scanResult.textContent = data.message || '‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
            // Refresh balance
            fetch('/api/me')
              .then(r => r.json())
              .then(user => {
                document.getElementById('balance').textContent = `‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${user.credit} ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï`;
              });
          })
          .catch(err => {
            scanResult.style.color = 'red';
            scanResult.textContent = err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
          });
      };
      const onScanFailure = (error) => {
        // We intentionally ignore scan failures as the scanner continues
        // to scan until a code is found. See library docs for details.
      };
      qrScanner.start(
        // Use a simple string for facingMode as recommended by html5-qrcode
        // documentation„Äê635396253272075‚Ä†L474-L485„Äë. Passing "environment" selects
        // the rear camera on most devices.
        { facingMode: 'environment' },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
      ).catch(err => {
        scanning = false;
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err);
      });
    });
    */
  </script>
</body>
</html>