<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="card">
      <h3>‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
    <p id="welcome"></p>
    <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <table id="users-table">
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
            <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
            <th>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</th>
            <th>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</th>
        </tr>
      </thead>
      <tbody id="users-body">
      </tbody>
    </table>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV -->
    <button id="exportBtn" class="btn-secondary mt-2">üìä‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (CSV)</button>

    <h3 style="margin-top:2rem;">üìÅ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</h3>
    <form id="importForm" enctype="multipart/form-data" style="margin-bottom:1rem;">
      <input type="file" name="file" accept=".csv" required />
      <button type="submit" class="btn-secondary">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
    </form>

    <h3>üè™‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
    <input type="text" id="merchantUsername" placeholder="username" />
    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
    <input type="password" id="merchantPassword" placeholder="password" />
    <button id="createMerchantBtn">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>

    <button id="logoutBtn" style="display:block;margin-top:2rem;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <script>
    // Fetch current user info to ensure the correct role
    fetch('/api/me')
      .then(res => {
        if (!res.ok) {
          window.location.href = '/login.html';
        }
        return res.json();
      })
      .then(user => {
        if (user.role !== 'admin') {
          // Redirect if not admin
          window.location.href = `/${user.role}.html`;
          return;
        }
        document.getElementById('welcome').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${user.username}!`;
        loadUsers();
      });

    // Load all users into the table
    function loadUsers() {
      fetch('/api/users')
        .then(res => res.json())
        .then(users => {
          const tbody = document.getElementById('users-body');
          tbody.innerHTML = '';
          users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${u.name || ''}</td>
              <td>${u.username}</td>
              <td>${u.role}</td>
              <td>${u.credit}</td>
              <td class="user-row">
                <input type="number" value="${u.credit}" min="0" />
                <button data-id="${u._id}">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
          // Add event listeners after rendering
          document.querySelectorAll('button[data-id]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const userId = btn.getAttribute('data-id');
              const input = btn.parentElement.querySelector('input');
              const newCredit = parseFloat(input.value);
              if (isNaN(newCredit)) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
              }
              fetch(`/api/users/${userId}/credit`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ credit: newCredit })
              })
                .then(res => {
                  if (!res.ok) {
                    return res.text().then(text => { throw new Error(text); });
                  }
                  return res.json();
                })
                .then(updated => {
                  alert(`‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á ${updated.username} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                  loadUsers(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                })
                .catch(err => alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`));
            });
          });
        })
        .catch(err => console.error(err));
    }

    // Logout handling
    document.getElementById('logoutBtn').addEventListener('click', () => {
      fetch('/logout')
        .then(() => {
          window.location.href = '/login.html';
        });
    });

    // Export summary handling
    document.getElementById('exportBtn').addEventListener('click', () => {
      // Trigger download of the Excel summary for all users.  Navigating
      // directly to the API endpoint will prompt the browser to
      // download the generated .xlsx file.
      window.location.href = '/api/export-users';
    });

    // Import employees from CSV
    document.getElementById('importForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      try {
        const res = await fetch('/api/import-employees', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        if (!res.ok) {
          throw new Error(text);
        }
        alert(text);
        // Refresh user list after import
        loadUsers();
      } catch (err) {
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`);
      }
    });

    // Create merchant account
    document.getElementById('createMerchantBtn').addEventListener('click', async () => {
      const username = document.getElementById('merchantUsername').value.trim();
      const password = document.getElementById('merchantPassword').value;
      if (!username || !password) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
        return;
      }
      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({ username, password, role: 'merchant' }).toString()
        });
        const text = await res.text();
        if (!res.ok) {
          throw new Error(text);
        }
        alert(text);
        // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        document.getElementById('merchantUsername').value = '';
        document.getElementById('merchantPassword').value = '';
        // reload users to show new merchant
        loadUsers();
      } catch (err) {
        alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`);
      }
    });
  </script>
</body>
</html>