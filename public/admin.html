<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô | ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .hint{color:#6b7280;font-size:.9rem}
    pre.code{background:#0b1020;color:#e5e7eb;padding:.75rem;border-radius:.5rem;overflow:auto;max-height:360px}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .mt-1{margin-top:.5rem}.mt-2{margin-top:1rem}.mt-3{margin-top:1.5rem}
    .message{padding:.5rem .75rem;border-radius:.5rem}
    .message.success{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .message.error{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:.5rem .6rem;text-align:left}
    th{background:#f8fafc;font-weight:600}
    a.copy{color:#2563eb;text-decoration:underline;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <h3>‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
    <p id="welcome"></p>

    <h3>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
    <div class="row mt-1">
      <button id="refreshUsers">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
      <button id="exportBtn" class="btn-secondary">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (CSV)</button>
    </div>
    <p class="hint mt-1">‡∏Ñ‡∏•‡∏¥‡∏Å <u>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/username</u> ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å <code>merchantId</code> ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>

    <table id="users-table" class="mt-1">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô/Username</th>
          <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
          <th>‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</th>
          <th>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</th>
          <th>‡πÑ‡∏≠‡∏î‡∏µ</th>
        </tr>
      </thead>
      <tbody id="users-body"></tbody>
    </table>

    <h3 class="mt-3">üìÅ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</h3>
    <form id="importForm" enctype="multipart/form-data" class="mt-1">
      <input type="file" name="file" accept=".csv" required />
      <button type="submit" class="btn-secondary">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
    </form>

    <h3 class="mt-3">üè™ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
    <div class="row mt-1">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
      <input type="text" id="merchantUsername" placeholder="username" />
      <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</label>
      <input type="password" id="merchantPassword" placeholder="password" />
      <button id="createMerchantBtn" class="btn-success">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>
    <div id="merchantMsg" class="message mt-1" style="display:none"></div>

    <!-- ‡∏õ‡∏¥‡∏î‡∏£‡∏≠‡∏ö/‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Lite) -->
    <h3 class="mt-3">üßæ ‡∏õ‡∏¥‡∏î‡∏£‡∏≠‡∏ö/‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Lite)</h3>
    <div class="row">
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤:</label>
      <select id="merchantSelect"></select>
      <span class="hint">‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏ merchantId ‡πÄ‡∏≠‡∏á</span>
      <input id="stlMerchant" placeholder="ObjectId ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" style="min-width:260px" />
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
      <input id="stlDate" type="date" />
      <button id="btnPreview">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      <button id="btnCommit" class="btn-success">‡∏õ‡∏¥‡∏î‡∏£‡∏≠‡∏ö & ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
    </div>
    <pre id="stlPreview" class="code mt-1">‡∏£‡∏≠‡∏Å‡∏î ‚Äú‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏õ‡∏¥‡∏î‡∏£‡∏≠‡∏ö‚Äù ‚Ä¶</pre>

    <button id="logoutBtn" class="btn-danger mt-3">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    function showMsg(el, text, type='success'){
      el.textContent = text;
      el.className = 'message ' + (type==='error'?'error':'success');
      el.style.display = 'block';
    }

    // ==== FIX: helper ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô popup blocker ====
    async function downloadCSV(url, filename){
      const res = await fetch(url, { credentials: 'same-origin' });
      if (!res.ok) throw new Error(await res.text());
      const blob = await res.blob();
      const a = document.createElement('a');
      const href = URL.createObjectURL(blob);
      a.href = href;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(href);
    }

    // ‡∏ï‡∏£‡∏ß‡∏à role ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    fetch('/api/me')
      .then(res => { if(!res.ok) location.href='/login.html'; return res.json(); })
      .then(user => {
        if (user.role !== 'admin') { location.href = `/${user.role}.html`; return; }
        $('welcome').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${user.username}!`;
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÇ‡∏•‡∏Ñ‡∏≠‡∏•)
        const today = new Date(); const yyyy=today.getFullYear();
        const mm=String(today.getMonth()+1).padStart(2,'0');
        const dd=String(today.getDate()).padStart(2,'0');
        $('stlDate').value = `${yyyy}-${mm}-${dd}`;
        loadUsers();
      });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡πÄ‡∏ï‡∏¥‡∏° select ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
    async function loadUsers(){
      const tbody = $('users-body');
      tbody.innerHTML = '<tr><td colspan="6">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</td></tr>';
      try{
        const users = await fetch('/api/users').then(r=>r.json());
        tbody.innerHTML = '';
        const merchants = [];
        users.forEach(u => {
          const tr = document.createElement('tr');
          const isMerchant = u.role === 'merchant';
          tr.innerHTML = `
            <td>${u.name || ''}</td>
            <td>${isMerchant ? `<a class="copy" data-copy="${u._id||u.id||''}">${u.username}</a>` : u.username}</td>
            <td>${u.role}</td>
            <td>${u.credit}</td>
            <td class="user-row">
              <input type="number" value="${u.credit}" min="0" />
              <button data-id="${u._id}">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
            </td>
            <td>${u._id || u.id || ''}</td>
          `;
          tbody.appendChild(tr);

          // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å merchantId ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô
          const cp = tr.querySelector('a.copy');
          if (cp) {
            cp.addEventListener('click', () => {
              const mid = cp.getAttribute('data-copy') || '';
              if (mid) {
                navigator.clipboard.writeText(mid).catch(()=>{});
                $('stlMerchant').value = mid;
                $('merchantSelect').value = mid;
              }
            });
          }

          if (isMerchant) {
            merchants.push({ id: u._id || u.id, label: (u.name || u.username || (u._id||u.id)) });
          }
        });

        // ‡πÄ‡∏ï‡∏¥‡∏° select ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
        const sel = $('merchantSelect');
        sel.innerHTML = '';
        const opt0 = document.createElement('option');
        opt0.value = ''; opt0.textContent = '‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Äî';
        sel.appendChild(opt0);
        merchants.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = `${m.label} (${m.id})`;
          sel.appendChild(opt);
        });

        // ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô
        tbody.querySelectorAll('button[data-id]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const userId = btn.getAttribute('data-id');
            const input = btn.parentElement.querySelector('input');
            const newCredit = parseFloat(input.value);
            if (isNaN(newCredit)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
            try{
              const res = await fetch(`/api/users/${userId}/credit`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credit: newCredit })
              });
              const body = await res.text();
              if (!res.ok) throw new Error(body);
              alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
              loadUsers();
            }catch(e){ alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (e.message||e)); }
          });
        });

      }catch(e){
        tbody.innerHTML = '<tr><td colspan="6">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>';
      }
    }
    $('refreshUsers').addEventListener('click', loadUsers);
    $('merchantSelect').addEventListener('change', e => $('stlMerchant').value = e.target.value || '');

    // Logout
    $('logoutBtn').addEventListener('click', () => {
      fetch('/logout').then(() => { location.href = '/login.html'; });
    });

    // Export users CSV (‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ‚Äî ‡πÉ‡∏ä‡πâ downloadCSV ‡∏Å‡∏±‡∏ô popup
    $('exportBtn').addEventListener('click', async () => {
      try{
        await downloadCSV('/api/export-users', 'users_summary.csv');
      }catch(e){
        alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (e.message || e));
      }
    });

    // Import CSV (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
    $('importForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const formData = new FormData(this);
      try{
        const res = await fetch('/api/import-employees', { method:'POST', body: formData });
        const text = await res.text();
        if (!res.ok) throw new Error(text);
        alert(text);
        loadUsers();
        this.reset();
      }catch(err){ alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`); }
    });

    // Create merchant
    $('createMerchantBtn').addEventListener('click', async ()=>{
      const username = $('merchantUsername').value.trim();
      const password = $('merchantPassword').value;
      const msg = $('merchantMsg'); msg.style.display='none';
      if (!username || !password) { showMsg(msg, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', 'error'); return; }
      try{
        const res = await fetch('/register', {
          method:'POST',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ username, password, role:'merchant', credit: 0 }).toString()
        });
        const text = await res.text();
        if (!res.ok) throw new Error(text);
        showMsg(msg, '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ', 'success');
        $('merchantUsername').value=''; $('merchantPassword').value='';
        loadUsers();
      }catch(err){ showMsg(msg, err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
    });

    // ===== Settlement (Lite) =====
    $('btnPreview').addEventListener('click', async ()=>{
      const merchantId = $('stlMerchant').value.trim();
      const date = $('stlDate').value;
      const out = $('stlPreview');
      if(!merchantId || !date){ out.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'; return; }
      out.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‚Ä¶';
      try{
        const r = await fetch(`/api/settlement/preview?merchantId=${encodeURIComponent(merchantId)}&date=${encodeURIComponent(date)}`);
        const j = await r.json();
        if(!r.ok) throw new Error(j.message || 'preview failed');
        out.textContent = JSON.stringify(j, null, 2);
      }catch(e){ out.textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (e.message || e); }
    });

    $('btnCommit').addEventListener('click', async ()=>{
      const merchantId = $('stlMerchant').value.trim();
      const date = $('stlDate').value;
      const out = $('stlPreview');
      if(!merchantId || !date){ out.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'; return; }
      out.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏£‡∏≠‡∏ö‚Ä¶';
      const commitBtn = $('btnCommit');
      commitBtn.disabled = true;
      try{
        const r = await fetch('/api/settlement/commit', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ merchantId, date })
        });
        const j = await r.json();
        if(!r.ok) throw new Error(j.message || 'commit failed');
        out.textContent = JSON.stringify(j, null, 2);
        const sid = j.settlement_id;

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV (‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°)
        await downloadCSV(`/api/settlement/${encodeURIComponent(sid)}/export-summary.csv`, `${sid}_summary.csv`);
        await downloadCSV(`/api/settlement/${encodeURIComponent(sid)}/export-ledger.csv`,  `${sid}_ledger.csv`);

        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏£‡πâ‡∏≤‡∏ô
        loadUsers();
      }catch(e){
        out.textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (e.message || e);
      } finally {
        commitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
